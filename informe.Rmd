---
title: "Informe para Alcoholistas V2"
author: "Alejandro Blasco"
date: "2023-08-05"
output:
  html_document:
    theme: darkly
    highlight: zenburn
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
      number_sections: true
    code_folding: hide
    ## includes:
    ##   before_body: before_body.html
---
<head>
  <link href="https://fonts.googleapis.com/css?family=Libre+Franklin:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Google+Font+Name&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" >
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Helvetica+Neue:400,700&display=swap" rel="stylesheet">
</head>

<style>
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #016763;
body {
  font-family: 'Libre Franklin', system-ui, 'Segoe UI', Roboto, Helvetica, 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Source Sans Pro', 'Lato', 'Helvetica Neue', sans-serif;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(forcats)
library(ggplot2)
library(gt)
library(geomtextpath)
library(gtExtras)
library(knitr)
library(pals)
library(Polychrome)
library(RColorBrewer)
library(readr)
library(tidyr)
library(tibble)
```

<!-- ## Introducción {.tabset .tabset-fade .tabset-pills} -->
## Introducción


### Descripción
***¿Qué datos son?***

La base posee datos sobre diferentes vinos y sus reseñas. El detalle de los datos se transcribe del diccionario:

```{r diccionario}
diccionario <- data.frame(
  Variable = c("pais", "nombre", "puntos", "precio", "provincia", "zona_1", "zona_2", "variedad", "vina", "titulo_resena"),
  Clase = c("caracter", "caracter", "entero", "entero", "caracter", "caracter", "caracter", "caracter", "caracter", "caracter"),
  Descripción = c("País de origen", "Nombre del vino", "Puntos con que fue calificado (1 a 100)", "Precio de la botella (en dólares)", 
                  "Lugar de origen", "Información adicional sobre zona de origen", "Más información adicional", 
                  "Variedad (ie, Pinot Noir)", "Nombre de la viña", "Título de la reseña")
)
dicc_url = "https://github.com/cienciadedatos/datos-de-miercoles/tree/master/datos/2019/2019-06-12"
dicc_pie = "Fuente: '<a href=\"dicc_url\">Datos de Miércoles</a>', proyecto semanal de datos organizado por la comunidad de R."

diccionario |>
  gt(rowname_col = "Variable") |>
  tab_options(table.width = "75%") |> 
  opt_stylize(style = 5, color = 'cyan') |> 
  # tab_stubhead(label = "Variable") |> 
  # gt_theme_dark() |> 
  tab_source_note(html(dicc_pie))
```

<!-- |**Variable**|**Clase**|**Descripción**| -->
<!-- |:----|:----|:----| -->
<!-- | pais | caracter | País de origen | -->
<!-- | nombre | caracter | Nombre del vino | -->
<!-- | puntos | entero | Puntos con que fue calificado (1 a 100) | -->
<!-- | precio | entero | Precio de la botella (en dólares) | -->
<!-- | provincia | caracter | Lugar de origen | -->
<!-- | zona_1 | caracter | Información adicional sobre zona de origen | -->
<!-- | zona_2 | caracter | Más información adicional | -->
<!-- | variedad | caracter | Variedad (ie, Pinot Noir) | -->
<!-- | vina | caracter | Nombre de la viña | -->
<!-- | titulo_resena| caracter | Título de la reseña | -->

---

### Origen
***¿De dónde provienen?***

La fuente de los datos es la revista [Wine Enthusiast](http://www.winemag.com/?s=&drink_type=wine), extraidos por *zackthoutt* y alojados en [Kaggle](https://www.kaggle.com/zynicide/wine-reviews), de donde fueron tomados y luego traducidos.

***¿Quién los tomó?***

<div style="text-align:center;">
  <img src="https://iili.io/HgxBOjn.jpg" alt="Imagen" style="max-width: 300px;">
</div>

---

### Fecha
***¿En qué período se tomaron?***

El dataset en español es de 2019-06-12 (dato obtenido de la [url](https://raw.githubusercontent.com/cienciadedatos/datos-de-miercoles/master/datos/2019/2019-06-12/vinos.csv) de origen del dataset). 

El original en inglés de Keggle fue actualizado por última vez hace 5 años (2018), pero no se indica la fecha exacta de procedencia de los datos.

---

## Análisis 

***Exploración de los datos***

```{r moda, include=FALSE}
## funcion para calcular moda
mode <- function(x, na.rm = FALSE) {
  
  if(na.rm){ #si na.rm es TRUE, remueve valores NA de x
    x = x[!is.na(x)]
  }

  val <- unique(x)
  return(val[which.max(tabulate(match(x, val)))])
}
```

### Muestreo

Primero se cargan los datos:
```{r carga-df, class.source = 'fold-show'}
vinos  <-  read_csv('datos/vinos.csv', show_col_types = FALSE)
```

Luego se presenta una muestra:
```{r muestra}
sample_n(vinos, 5) |>
  gt() |> 
  # tab_options(table.background.color = "#25303f",
  #             heading.background.color = "#003258") |> 
  gt_theme_pff() |>
  # gt_highlight_cols(columns = c(puntos,precio), fill = "#e4e8ec")  |> 
  tab_header(title = "Reseñas de Vinos") |>
   tab_footnote(
    footnote = "Muestra aleatoria de 5 registros.",
    locations = cells_title("title")) |> 
  tab_source_note(
    source_note = html("Fuente: Revista <a href=\"www.wineenthusiast.com\">Wine Enthusiast</a>."))
```

```{r variables, include=FALSE}
#valores útiles
tamanio_muestra <- nrow(vinos)
precio_media  <-  mean(vinos$precio, na.rm = TRUE)
precio_ds <-  sd(vinos$precio, na.rm = TRUE)
precio_max <- max(vinos$precio, na.rm = TRUE) 
precio_caro <- precio_media + 3*precio_ds
vinos_caros <- nrow(filter(vinos, precio > precio_caro)) ## se estima con media + 3 desvios estandar.
puntos_media <- mean(vinos$puntos, na.rm = TRUE)
puntos_ds <-  sd(vinos$puntos, na.rm = TRUE)
puntos_min <- min(vinos$puntos, na.rm = TRUE)
puntos_max <- max(vinos$puntos, na.rm = TRUE)
paises_len <- length(unique(na.omit(vinos$pais)))
variedades_len <- length(unique(na.omit(vinos$variedad)))
cepas <- sort(unique(na.omit(vinos$variedad)))
```

Se almacenan las dimensiones de la base en variables:
```{r dimensiones}
observaciones <- nrow(vinos)
variables <- ncol(vinos)
```

El dataset tiene ``r observaciones`` observaciones y ``r variables`` variables.

---

### Variables a analizar

Se consideran las variables `puntos` y `precio` para el análisis, ya que son las únicas numéricas, por lo que permiten mayores análisis que el resto de las variables del dataset, que son categóricas.

---

### Tendencia Central
¿Cuál es su valor medio y desvío estándar?

```{r puntos-mtc, echo=FALSE}
pts_mtc <- summarise(vinos, 
                     media = mean(puntos, na.rm = TRUE),
                     mediana = median(puntos, na.rm = TRUE),
                     moda = mode(puntos, na.rm = TRUE),
                     ds = sd(puntos, na.rm = TRUE))

pre_mtc <- summarise(vinos,
                     media = mean(precio, na.rm = TRUE),
                     mediana = median(precio, na.rm = TRUE),
                     moda = mode(precio, na.rm = TRUE),
                     ds = sd(precio, na.rm = TRUE))

mtc <- rbind(pts_mtc, pre_mtc) |>
  add_column("variable" = c("Puntos","Precio"),
             .before = "media") |>
  gt(rowname_col = 'variable') |>
  tab_header(
    title = "Medidas de Tendencia Central") |>
  cols_label(media = "Media",
             mediana = "Mediana",
             moda = "Moda", 
             ds = "Desvío") |>
  fmt_number(columns = c(2,5), decimals = 2) |> 
  opt_stylize(style = 1, color = 'cyan')
mtc
  
```

*Puntos*

Por la media y el desvío, se puede estimar, asumiendo que las calificaciones tienen distribución normal, que el 68% de la muestra se encuentra entre ``r round(puntos_media - puntos_ds)`` y ``r round(puntos_media + puntos_ds)`` puntos.

La similitud entre media, mediana y moda permite suponer una distribución, si no normal, al menos simétrica.

*Precio*

Por la media y el desvío, se puede suponer que la distribución no es normal.

La diferencia entre moda, mediana y media, confirma esto, permitiendo estimar una distribución asimétrica hacia la derecha.

---

### Rango
¿Cuál es su rango (valor máximo y valor mínimo)?

```{r rango}
pts_rng <- summarise(vinos, 
                     min = min(puntos, na.rm = TRUE),
                     max = max(puntos, na.rm = TRUE))

pre_rng <- summarise(vinos,
                     min = min(precio, na.rm = TRUE),
                     max = max(precio, na.rm = TRUE))

rng <- rbind(pts_rng, pre_rng) |>
  add_column("variable" = c("Puntos","Precio"),
             .before = "min") |>
  gt(rowname_col = 'variable') |>
  tab_header(
    title = "Rango") |>
  cols_label(min = "Mínimo",
             max = "Máximo") |>
  opt_stylize(style = 2, color = 'cyan')
rng
```

*Puntos*

Puede observarse que los puntos no bajan de ``r puntos_min``, por lo que la calificación oscila en un rango de solo ``r puntos_max - puntos_min`` puntos.

*Precio*

Se confirma que los precios altos tienen gran dispersión y se alejan mucho de la media, lo que ratifica una asimetría hacia la derecha.

---

### Anomalías
¿Hay alguna anomalía que sugiera que hay datos incorrectos?

No hay evidencias de que existan anomalías en los datos, solo algunos valores llamativos, como la diferencia entre la media de precios y los precios máximos, ya que, aunque el máximo es US\$``r precio_max``, solo existen ``r vinos_caros`` (de un total de ``r tamanio_muestra``) que superen los US\$``r round(precio_caro)`` (promedio de precio + 3 desvíos estándar). 

También llamó la atención la cantidad de cepas o variedades de vino (``r variedades_len``), pero únicamente porque superó ampliamente el número esperado.

La dispersión de precios puede observarse mejor mediante un gráfico. Primero seteamos un tema:

```{r tema, class.source = 'fold-show'}
theme_set(theme_dark() + 
            theme(plot.background = element_rect(fill = "#555555"),
                  axis.text = element_text(color = "#222222"),
                  legend.background = element_rect(fill = "#888888")
                  ))
```

Y luego graficamos:

```{r precio-dispersion, out.width = '120%'}
#| fig.alt: "Histograma de dispersión de precios. El eje X indica el precio en dólares, y el Y la cantidad de reseñas; posee una cúspide de 12828 reseñas para los vinos de precio cercano a 15 dólares, con una marcada asimetría hacia la derecha, por lo que se filtraron valores mayores a 160 dólares."
p <- vinos |>
  filter(precio <= precio_caro) |>
  ggplot() + 
  geom_histogram(binwidth = 3, 
                 show.legend = FALSE, 
                 aes(x = precio,fill = cut(precio, 100))) +
  scale_fill_viridis_d(option = "A", direction = -1) +
  scale_x_continuous(labels = scales::dollar_format(suffix = " USD", prefix = "")) +
  labs(title = "Histograma de Precios",
       # caption = paste0("Las reseñas de valores mayores a ",
       #                   paste0("$", round(precio_caro,2)), " fueron omitidas."),
       x = "Precio", 
       y = "Cantidad de Reseñas")

#ver https://community.rstudio.com/t/geom-histogram-max-bin-height/10026
#ver https://github.com/tidyverse/ggplot2/issues/5004
cuspide <- select(layer_data(p)[which.max(layer_data(p)$y), ],x,y)

# Añade la marca y la nota al pie
p <- p +
  geom_text(data = cuspide,
            aes(x = x, y = y,
                label = paste0("Cúspide\nUSD", x, "\n", y," reseñas")),
            nudge_x = 2, nudge_y = -500, color = "#333333", hjust = 0) + 
  geom_point(data = cuspide, 
             aes(x = x, y = y),
             shape = 20, size = 3, fill = NA, color = "#333333") +
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 1, 
           label = paste0("Las reseñas de valores mayores a ",
                         paste0("$", round(precio_caro,2)), " fueron omitidas."),
           color = "#333333")  # Nota en la parte superior del área del gráfico

show(p)
```

(los precios mayores a ``r round(precio_caro)`` fueron excluidos)

---

### Tamaño
¿Cuántas observaciones hay por cada grupo? ¿Cuántos valores faltantes? ¿Hay diferencias?

Se contabiliza el porcentaje de valores N/A (vacíos), para cada una de las variables:

```{r proporcion-na}
proporcion <- tibble::rownames_to_column(data.frame(colSums(is.na(vinos))/nrow(vinos)),
                                                  "variable")
colnames(proporcion)[2] <- "Cantidad de NA"
proporcion |> 
gt() |>
  gt_theme_pff() |>
  fmt_percent(columns = 2, decimals = 2)
```

Pueden encontrarse bastantes valores faltantes, pero únicamente en las columnas de nombre (``r round(proporcion[2,2]*100,2)``%), region_1 (``r round(proporcion[6,2]*100,2)``%) y region_2 (``r round(proporcion[7,2]*100,2)``%).

---

## Hipótesis

Se presentan 3 hipótesis:

1. Podría existir una diferencia notable entre el promedio de precios de los vinos según el país.
2. Habría una incremento en el precio promedio del vino conforme su puntaje.
3. Existirían variedades que podrían tener un precio promedio significativamente mayor, pero no así su puntaje.

---

### *Precio x Pais*
>Podría existir una diferencia notable entre el promedio de precios de los vinos según el país.


Para analizar esto, primero, se realiza un gráfico para ver los promedios de precio x país:

```{r precio_x_pais, fig.asp = 1.20 }
#| fig.alt: "Gráfico de barras horizontales con 43 paises y el precio promedio de sus vinos; al tope Suiza con promedio de 85.29 dolares promedio, seguido de Inglaterra con 51.68, y último Ucrania con 9.21."
# https://sebastiansauer.github.io/figure_sizing_knitr/

paleta_pais <- createPalette(43,  c("#ff0000", "#00ff00", "#0000ff")) # paleta personalizada. no funca

vinos |> 
  filter(!is.na(pais)) |> 
  group_by(pais) |> 
  summarise(precio_promedio = mean(precio, na.rm = TRUE)) |>
  filter(!is.na(precio_promedio)) |>
  ggplot(aes(precio_promedio, reorder(pais, precio_promedio))) +
  geom_col(width = 0.7, alpha = 0.6, show.legend = FALSE,
           aes(fill = reorder(pais, precio_promedio),
               color=reorder(pais, precio_promedio))) +
  scale_fill_viridis_d(aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = c(0.01,0),
                     labels = scales::dollar_format(suffix = " USD", prefix = "")) + 
  # scale_colour_manual(values = paleta_pais,aesthetics = c("colour", "fill")) + #no logré que funcione
  geom_text(aes(label = sprintf("USD %.2f", precio_promedio)),
            hjust = 1, size = 2.5, nudge_y = 0.04) +
  labs(title = "Precio promedio de los vinos por pais",
       subtitle = "Listado completo",
       x = "Precio", y = "Pais")
```


Se ve una gran dispersión, con precios que van desde menos de US\$10 (Ucrania), hasta más de US\$85 (Suiza).

Para verificar que estos promedios sean estadísticamente significativos, se analiza cuantas reseñas hay de cada pais:

```{r menos-resenias}
vinos |> 
  filter(!is.na(pais)) |> 
  group_by(pais) |> 
  summarise(resenias = n()) |>
  arrange(resenias) |>
  head(10) |> 
  gt() |> 
  tab_header(title = "Paises con menos reseñas") |>
  cols_label(pais = "País", resenias = "Reseñas") |> 
  gt_theme_dark()
```

Destacan varios paises casi sin reseñas. Gráficamente:

```{r resenias_x_pais, fig.asp = 1.20}
#| fig.alt: "Gráfico de barras horizontales con 43 paises y su cantidad de reseñas; al tope EEUU con 54504 , seguido de Francia con 22093 e Italia con 1950. Salta a España con 6645; más de la mitad de los paises tienen menos de 100 reseñas."
vinos |> 
  filter(!is.na(pais)) |> 
  group_by(pais) |> 
  summarise(resenias = n()) |>
  ggplot(aes(resenias, reorder(pais, resenias))) +
  geom_col(width = 0.7, show.legend = FALSE, 
           aes(color=reorder(pais, resenias),
           fill=reorder(pais, resenias), 
           alpha = 0.6)) +
  geom_text(data = . %>% filter(resenias > 3000), aes(label = resenias),
            hjust = 1, size = 2.5, nudge_y = 0.04) +
  geom_text(data = . %>% filter(resenias < 3000), aes(label = resenias),
            hjust = 0, size = 2.5, nudge_x = 350, nudge_y = 0.04) +
    scale_fill_viridis_d(option = "A", 
                       direction = 1, 
                       aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = c(.01,0)) + 
  labs(title = "Cantidad de Reseñas por pais",
       x = "Reseñas",
       y = "Pais")
```


Al existir paises con tan pocas reseñas, conviene filtrarlos o agruparlos:

```{r precio_pais_grupo}
#| fig.alt: "Gráfico de barras horizontales con 17 paises y una categoria otros para agrupar aqellos con menos de 130 reseñas (0,1% de la muestra) y sus precios promedio; al tope Alemania con 42,26 dólares , seguido de Francia con 41.14.Al final Bulgaria con 14.65 dólares promedio."
prop_resenias = 0.001
vinos |> 
  filter(!is.na(pais)) |> 
  group_by(pais = fct_lump_prop(pais, prop_resenias, other_level = "Otros")) |> 
  summarise(precio_promedio = mean(precio, na.rm = TRUE), resenias = n()) |>
  filter(!is.na(precio_promedio)) |> 
  ggplot(aes(precio_promedio, 
             reorder(pais, precio_promedio))) +
  geom_col(width = 0.7, show.legend = FALSE,
           aes(color=reorder(pais, precio_promedio),
               fill=reorder(pais, precio_promedio),
               alpha = 0.6)) +
  geom_text(aes(label = sprintf("USD %.2f", precio_promedio)),
            hjust = 1, size = 3, nudge_y = 0.04) +
  scale_fill_viridis_d(option = "F", 
                       direction = 1, 
                       aesthetics = c("colour", "fill")) +
  scale_x_continuous(expand = c(0.01,0)) + 
    labs(title = "Precio promedio de los vinos por pais",
       subtitle = "Versión resumida",
       caption = paste0("*Los paises con menos de ",
                         round(tamanio_muestra*prop_resenias,0),
                        " reseñas fueron unificados en la categoría 'otros'."),
       x = "Precio", y = "Pais")
```

Otros = paises con pocas reseñas

(<0,1% del tamaño de la muestra) 

*Conclusiones:* Se constata una diferencia significativa entre los precios promedio según el pais de origen del vino, ya sea contabilizando todos o excluyendo los menos representativos. 

Respecto de la cantidad de reseñas, no es posible establecer si es una limitación de la muestra, con mayor acceso o interés en vinos locales (las reseñas de EEUU casi triplican a las del segundo, Francia), si existen menos reseñas por tener menor producción de vino, u otros motivos. 

Tampoco es posible determinar los motivos de la variación de precio. Puede suponerse que influya la reputación vitivinícola, el tamaño de las economías (países con economías desarrolladas parecen ocupar los 1ros puestos), u otras causas.

---

### *Precio vs Puntaje*
>Habría una incremento en el precio promedio del vino conforme su puntaje.

Primeramente, se elabora un gráfico de dispersión de la relación puntaje y precio, eliminando vinos de precios muy altos (> 1000), ya que limitan la utilidad el gráfico:

Este gráfico brinda poca información. Parecería que existen vinos de precio bajo en casi todos los puntajes, y el precio mínimo parece elevarse ligeramente a partir del puntaje 95.

```{r linear}
#| fig.alt: "Gráfico de dispersión de la relación entre precio y puntaje. El grueso de la muestra se agrupa en la parte inferior entre 100 y 200 dólares, pero hay valores que rozan los 1000 dolares, y estos outliers son más frecuentes para los puntajes más altos."
p <- vinos |>
  filter(!is.na(puntos)) |> 
  filter(!is.na(precio)) |> 
  filter(precio < 1000) |>
  ggplot(aes(x=puntos, y=precio, color=precio)) +
  scale_y_continuous(labels = scales::dollar_format(suffix = " USD", prefix = "")) +
  geom_jitter(show.legend = FALSE) +
  # scale_color_gradientn(colors = brewer.pal(5, "YlOrBr")) +
  scale_color_viridis_c(option = "F", direction = 1) +
  # scale_color_gradient(low="blue", high="red") + 
  labs(title = "Relación precio-puntaje",
       subtitle = "escala lineal",
       x = "Puntos", y = "Precio", colour = "Precio")
show(p)
```

Si cambiamos la escala:

```{r log}
#| fig.alt: "Gráfico de dispersión de la relación entre precio y puntaje, esta vez en escala logarítmica. Con esta escala se logra observar una correlación lineal, graficada mediante una línea que muestra la relación de mayor precio a mayor puntaje."
q <- vinos |>
  filter(!is.na(puntos)) |> 
  filter(!is.na(precio)) |> 
  ggplot(aes(x = puntos, y = precio)) +
  scale_y_log10(labels = scales::dollar_format(suffix = " USD", prefix = "")) +
  geom_jitter(aes(colour = precio), show.legend = FALSE) +  # Mover la estética aquí
  scale_color_viridis_c(option = "F", direction = 1, trans = "log") +
  labs(title = "Relación precio-puntaje",
       subtitle = "escala logarítmica",
       x = "Puntos", y = "Precio") +
  geom_labelsmooth(method = "lm",
                   formula = y ~ x,
                   label = "A mayor puntaje, mayor precio", alpha = 0.5,
                   arrow = arrow())
    # stat_smooth(method = "lm",
    #         formula = y ~ x,
    #         geom = "smooth",
    #         color="black")
show(q)
```

Una escala logarítmica permite apreciar mucho mejor la relación existente entre precio y puntaje.

Vamos a comprobar el precio promedio para cada puntaje: 
 
```{r p_prom_vs_punto}
#| fig.alt: "Gráfico de barras de la relación entre precio promedio y puntaje. Se evidencia un incremento exponencial del precio promedio, que se acoda a partir de los 94-95 puntos."
p <- vinos |>
  filter(!is.na(puntos)) |> 
  filter(!is.na(precio)) |>
  group_by(puntos) |> 
  summarise(precio_promedio = mean(precio, na.rm = TRUE)) |>
  ggplot(aes(x=puntos, y=precio_promedio, fill=precio_promedio)) + 
  scale_y_continuous(labels = scales::dollar_format(suffix = " USD", prefix = "")) +
  geom_col() +
  scale_fill_distiller(palette = "YlGnBu") +
  labs(title = "Precio Promedio vs Puntaje",
       x = "Puntos", y = "Precio", fill = "Precio (USD)")
show(p)
```

Con esto se aprecia que el precio promedio de los vino se incrementa, pero el crecimiento sigue una tendencia más exponencial que lineal.

También podemos observar como se distribuyen los puntajes:

```{r tabla_pre_pun_res}
vinos |>
  filter(!is.na(puntos)) |> 
  filter(!is.na(precio)) |>
  group_by(puntos) |> 
  summarise(precio_promedio = mean(precio, na.rm = TRUE), resenias = n()) |> 
  gt() |> 
  tab_header(title = "Relaciones", subtitle = "Puntos vs Precio Promedio vs Reseñas") |> 
  cols_label(puntos = "Puntos", precio_promedio = "Precio Promedio", resenias = "Reseñas") |>
  fmt_number(col = 2, decimals = 2) |> 
  gt_theme_dark()
```

```{r resenias_puntaje}
#| fig.alt: "Histograma de distribución de reseñas conforme el puntaje. El mayor número de reseñas son de 88 puntos (más de 16000)  y el resto de las reseñas se distribuye de manera semejante a la normal,entre los 80 y los 100 puntos, con una leve asimetría hacia la derecha."
vinos |>
  filter(!is.na(puntos)) |> 
  filter(!is.na(precio)) |>
  group_by(puntos) |> 
  summarise(precio_promedio = mean(precio, na.rm = TRUE), resenias = n()) |> 
  ggplot(aes(x = puntos, y = resenias)) +
  geom_col(aes(colour = resenias, fill = resenias),width = 0.9, alpha = 0.3) +
  scale_fill_viridis_c(option = "A",
                       direction = 1,
                       aesthetics = c("colour", "fill")) +
  # scale_fill_distiller(palette = "YlGnBu") +
  labs(title = "Cantidad de Reseñas por Puntaje",
       color = "# Reseñas",
       fill = "# Reseñas",
       x = "Puntos",
       y = "Cantidad de Reseñas")
```

Se observa que los puntajes parecerían tene una distribución semejante a la normal.

```{r eval=FALSE, include=FALSE}
## Esta sección quedó descartada
#Vamos a ver si existe algun otro rasgo relevante de la relación puntaje y precio. Primeramente creamos una nueva variable que las relacione:
vinos_ratio <- vinos |>
mutate(ratio = puntos/log(precio))

## Se divide el puntaje por el logaritmo del precio, ya que se observó que no tienen una relación lineal. Con esto, lo que se intenta es obtener un valor que oriente sobre la relación calidad/precio de un vino.
## *Ratio*
## 
summarise(vinos_ratio, ratio_min = min(ratio, na.rm = TRUE),
          ratio_max = max(ratio, na.rm = TRUE),
          ratio_md = mean(ratio, na.rm = TRUE),
          ratio_ds = sd(ratio, na.rm = TRUE)) |>
  kable(col.names = c("Mínimo de Ratio", "Máximo de Ratio", "Media", "Desvío Estándar")) |>
  kable_styling(full_width = FALSE)

## Graficamos la relacíon entre la cantidad de reseñas y este ratio puntaje/precio:

vinos_ratio |>
  filter(!is.na(ratio)) |>
  group_by(cut(ratio, 15)) |>
  summarise(n = n())

vinos_ratio |>
  filter(!is.na(ratio)) |>
  group_by(ratio) |>
  ggplot(aes(ratio)) +
  geom_histogram(colour = "violetred4", fill = "violetred4",alpha = 0.3, binwidth = 0.35)
```

Por último, para relacionar con la hipótesis 1, comparamos puntaje promedio conforme paises:

```{r punto_promedio_pais}
#| fig.alt: "Gráfico de barras horizontales con los puntajes promedio por pais. Austria a la cabeza con un promedio de 90.1, seguida por Alemania con 89.85; los promedios tienen poca dispersión con Chile al final con 86.49."
vinos |> 
  filter(!is.na(pais)) |> 
  group_by(pais = fct_lump_prop(pais, prop_resenias, other_level = "Otros")) |> 
  # group_by(pais) |> 
  summarise(puntos_promedio = mean(puntos, na.rm = TRUE), resenias = n()) |>
  # filter(resenias > tamanio_muestra/1000) |> 
  filter(!is.na(puntos_promedio)) |> 
  ggplot(aes(puntos_promedio, reorder(pais, puntos_promedio))) +
  geom_col(width = 0.7,
           aes(color = puntos_promedio,
               fill = puntos_promedio),
           alpha = 0.6,
           show.legend = FALSE) +
  geom_text(aes(label = sprintf("%.2f", puntos_promedio)),
            hjust = 1, size = 3, nudge_y = 0.04) +
  scale_fill_viridis_c(option = "B",
                       direction = 1,
                       aesthetics = c("colour", "fill")) +
  labs(title = "Puntaje Promedio por Pais",
       subtitle = "Listado de paises resumido",
       caption = paste0("*Los paises con menos de ",
                         round(tamanio_muestra*prop_resenias,0),
                        " reseñas fueron unificados en la categoría 'otros'."),
       x = "Puntaje",
       y = "Pais") +
  coord_cartesian(xlim = c(80, 100))
```

Se ve, que al contrario del precio promedio, el puntaje promedio no parecería tiene mucha variabilidad.

*Conclusiones:* Entendemos que existe una correlación entre el puntaje y el precio, aunque desconocemos si esto puede deberse a un sesgo de quien evalúa (que podría tender a asignar puntajes altos a vinos caros) o a una efectiva correlación entre calidad y precio, ya que hay muchos vinos de bajo precio con alto puntaje.

---

### *Precio/Puntaje x Variedad*
>Existirían variedades que podrían tener un precio promedio significativamente mayor, pero no así su puntaje.

```{r variedades_pocas_resenias}
vinos |> 
  filter(!is.na(variedad)) |> 
  group_by(variedad) |> 
  summarise(puntos_promedio = mean(puntos, na.rm = TRUE),
            precio_promedio = mean(precio, na.rm = TRUE),
            resenias = n()) |> 
  arrange(resenias) |> 
  head(10) |> 
  gt(rowname_col = "variedad") |> 
  tab_header(title = "Variedades de Vino", subtitle = "Muestra de variedades con escasas Reseñas") |>
  tab_stubhead(label = "Variedad") |> 
  cols_label(puntos_promedio = "Puntaje Promedio",
             precio_promedio = "Precio Promedio",
             resenias = "Reseñas") |>
  gt_theme_dark()  
```

Por la cantidad de variedades encontradas (``r variedades_len``), y la escasa cantidad de reseñas de muchas, se agrupan en "Otras" las variedades sin una cantidad significativa de reseñas.

```{r punt_vs_precio_x_variedad, fig.asp = 1.10}
#| fig.alt: "Gráfico de barras horizontales. A la izquierda, el puntaje promedio por variedad. A la derecha, el precio promedio x variedad, con categorías ordenadas de forma descendente en base al prcio promedio. Aunque parece existir cierta relacion entre precio y puntaje, existiendo puntajes más bajos en la parte inferior, existen excepciones, "
resenia_x_variedad = 0.005
paleta_rdylbu <- brewer.pal(11, "RdYlBu")

vinos |> 
  filter(!is.na(variedad)) |> 
  group_by(variedad = fct_lump_min(variedad, tamanio_muestra*resenia_x_variedad, other_level = "Otras")) |>
  summarise(puntos_promedio = mean(puntos, na.rm = TRUE),
            precio_promedio = mean(precio, na.rm = TRUE),
            resenias = n()) |>
  ## filter(resenias > tamanio_muestra/200) |> 
  arrange(resenias) |>
  ggplot() +
  geom_col(aes(-puntos_promedio+80,
               reorder(variedad, precio_promedio),
           color=puntos_promedio,
           fill=puntos_promedio),
           width = 0.7, 
           alpha = 0.6) +
  geom_text(aes(0,
               reorder(variedad, precio_promedio),
                label = sprintf("%.2f", puntos_promedio)),
            hjust = 0, size = 2.5, nudge_x = 0.5,nudge_y = 0.04) +
  scale_color_viridis_c(option = "A", direction = 1, aesthetics = c("colour", "fill")) + 
  geom_col(aes(precio_promedio,
               reorder(variedad, precio_promedio)),
               fill="red4",
               color="red4",
           width = 0.7,
           alpha = 0.6) +
  # scale_fill_gradient(low = "#4B0082", high = "#D3B9D3", aesthetics = c("colour", "fill")) +
    labs(title = "Puntaje vs Precio por Variedad",
       caption = paste0("*Las variedades con menos de ",
                         round(tamanio_muestra*resenia_x_variedad,0),
                        " reseñas fueron unificadas en la categoría 'otras'."),
       color = "Puntaje Promedio",
       fill = "Puntaje Promedio",
       x = "Puntaje - Precio",
       y = "Variedad")
```

Para este gráfico, se opusieron puntaje a la izquierda (escala de 80 a 100) y precio a la derecha.

*Conclusiones:* Se estima que el gráfico da cuenta de que  existe una diferencia del precio promedio de las variedades más reseñadas, pero que este precio no correlaciona (al menos a simple vista) con el puntaje promedio. Lo anterior podría deberse a varias causas. Una hipótesis es que las variedades o cepas podrían tener un precio promedio distinto en base a los costos de su producción, la dificultad específica de su cultivo,  tiempo de procesamiento, o su exclusividad, entre otros.

---

`Links Consultados:`

```{r links-utiles}
# https://aberdeenstudygroup.github.io/studyGroup/lessons/SG-T1-GitHubVersionControl/VersionControl/
# https://bbc.github.io/rcookbook/
# https://bookdown.org/yihui/rmarkdown-cookbook/fold-show.html
# https://bookdown.org/yihui/rmarkdown/html-document.html#floating_toc
# https://buddy.works/blog/5-types-of-git-workflows
# https://campus.unab.edu.ar/pluginfile.php/115477/mod_resource/content/1/ggplot2-theme-elements-reference-v2.pdf
# https://cran.r-project.org/web/packages/ymlthis/vignettes/yaml-fieldguide.html
# https://github.com/EmilHvitfeldt/r-color-palettes#palettes-sorted-by-package-alphabetically
# https://github.com/jrnold/ggthemes
# https://gt.albert-rapp.de/getting_started
# https://gt.rstudio.com/articles/intro-creating-gt-tables.html
# https://imagecolorpicker.com/color-code/25303f
# https://inbo.github.io/git-course/course_rstudio.html
# https://isabella-b.com/files/ggplot2-theme-elements-reference-v2.pdf
# https://monashdatafluency.github.io/r-rep-res/yaml-header.html
# https://rdrr.io/github/jthomasmock/gtExtras/src/R/gt_theme_dark.R
# https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/
```
